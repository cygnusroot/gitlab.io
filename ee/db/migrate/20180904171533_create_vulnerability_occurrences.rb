# frozen_string_literal: true

class CreateVulnerabilityOccurrences < ActiveRecord::Migration
  include Gitlab::Database::MigrationHelpers

  DOWNTIME = false

  def up
    create_table :vulnerability_occurrences do |t|
      t.timestamps_with_timezone null: false

      t.integer :severity
      t.integer :confidence

      t.integer :scanner_id, null: false
      t.foreign_key :vulnerability_scanners, column: :scanner_id, on_delete: :cascade
      t.integer :pipeline_id, null: false
      t.foreign_key :ci_pipelines, column: :pipeline_id, on_delete: :cascade

      t.references :project, null: false, index: true, foreign_key: { on_delete: :cascade }
      t.integer :category, null: false

      t.binary :first_seen_in_commit_sha, null: false, limit: 20
      t.binary :project_fingerprint, null: false, limit: 20
      t.binary :location_fingerprint, null: false, limit: 20
      t.binary :primary_identifier_fingerprint, null: false, limit: 20

      t.string :ref, null: false
      t.string :name, null: false
      t.string :metadata_version, null: false
      t.text :raw_metadata, null: false

      t.index :project_fingerprint, length: Gitlab::Database.mysql? ? 20 : nil
      t.index [:location_fingerprint, :primary_identifier_fingerprint, :project_id, :scanner_id, :ref], unique: true, name: 'vulnerability_occurrences_unique_index', length: { location_fingerprint: 20, primary_identifier_fingerprint: 20 }
    end
  end

  def down
    drop_table :vulnerability_occurrences
  end
end
